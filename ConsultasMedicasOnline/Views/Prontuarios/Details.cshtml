@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@model ConsultasMedicasOnline.Models.Prontuario

@{
    ViewData["Title"] = "Detalhes do Prontu√°rio";
    bool isMedico = User.IsInRole("Medico");
    bool isAdmin = User.IsInRole("Administrador");
}

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-white py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-medical-800">
                    <i class="fas fa-file-medical text-primary-600 mr-3"></i>
                    Prontu√°rio M√©dico
                </h1>
                <p class="text-lg text-medical-600 mt-2">
                    Consulta de @Model.Consulta.DataHora.ToString("dd/MM/yyyy '√†s' HH:mm")
                </p>
            </div>
            
            <div class="flex space-x-3">
                <a href="@Url.Action("Print", new { id = Model.Id })" target="_blank" class="bg-info-100 text-info-700 px-4 py-2 rounded-lg hover:bg-info-200 transition-colors duration-200">
                    <i class="fas fa-print mr-2"></i>
                    Imprimir
                </a>
                
                <a href="@Url.Action("Details", "Consultas", new { id = Model.ConsultaId })" class="bg-medical-100 text-medical-700 px-4 py-2 rounded-lg hover:bg-medical-200 transition-colors duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Voltar para Consulta
                </a>
                
                @if ((isMedico && Model.Medico.UsuarioId == User.FindFirstValue(ClaimTypes.NameIdentifier)) || isAdmin)
                {
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="bg-warning-100 text-warning-700 px-4 py-2 rounded-lg hover:bg-warning-200 transition-colors duration-200">
                        <i class="fas fa-edit mr-2"></i>
                        Editar
                    </a>
                }
            </div>
        </div>

        <!-- Patient and Doctor Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                <h2 class="text-xl font-semibold text-medical-800 mb-4 flex items-center">
                    <i class="fas fa-user text-primary-600 mr-2"></i>
                    Dados do Paciente
                </h2>
                
                <div class="flex items-center mb-4">
                    <div class="h-14 w-14 bg-purple-100 rounded-full flex items-center justify-center">
                        <span class="text-purple-600 text-lg font-bold">
                            @Model.Paciente.Usuario.Nome.First()@Model.Paciente.Usuario.Sobrenome.First()
                        </span>
                    </div>
                    <div class="ml-4">
                        <h3 class="font-semibold text-lg text-medical-800">
                            @Model.Paciente.Usuario.Nome @Model.Paciente.Usuario.Sobrenome
                        </h3>
                        <p class="text-medical-600">
                            @if (Model.Paciente.DataNascimento.HasValue)
                            {
                                <span>@Model.Paciente.DataNascimento.Value.ToString("dd/MM/yyyy")</span>
                                <span class="text-xs ml-2">(@(DateTime.Now.Year - Model.Paciente.DataNascimento.Value.Year) anos)</span>
                            }
                            else
                            {
                                <span class="text-medical-500">Data de nascimento n√£o informada</span>
                            }
                        </p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-medical-600">Tipo Sangu√≠neo</p>
                        <p class="font-semibold text-medical-800">
                            @if (!string.IsNullOrEmpty(Model.Paciente.TipoSanguineo))
                            {
                                @Model.Paciente.TipoSanguineo
                            }
                            else
                            {
                                <span class="text-medical-500">N√£o informado</span>
                            }
                        </p>
                    </div>
                    
                    <div>
                        <p class="text-sm text-medical-600">Alergias</p>
                        <p class="font-semibold text-medical-800">
                            @if (!string.IsNullOrEmpty(Model.Paciente.Alergias))
                            {
                                @Model.Paciente.Alergias
                            }
                            else
                            {
                                <span class="text-medical-500">Nenhuma alergia registrada</span>
                            }
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                <h2 class="text-xl font-semibold text-medical-800 mb-4 flex items-center">
                    <i class="fas fa-user-md text-primary-600 mr-2"></i>
                    M√©dico Respons√°vel
                </h2>
                
                <div class="flex items-center mb-4">
                    <div class="h-14 w-14 bg-blue-100 rounded-full flex items-center justify-center">
                        <span class="text-blue-600 text-lg font-bold">
                            @Model.Medico.Usuario.Nome.First()@Model.Medico.Usuario.Sobrenome.First()
                        </span>
                    </div>
                    <div class="ml-4">
                        <h3 class="font-semibold text-lg text-medical-800">
                            Dr. @Model.Medico.Usuario.Nome @Model.Medico.Usuario.Sobrenome
                        </h3>
                        <p class="text-medical-600">
                            @Model.Medico.Especialidade.Nome - CRM @Model.Medico.CRM/@Model.Medico.EstadoCRM
                        </p>
                    </div>
                </div>
                
                <div class="text-sm text-medical-700 mt-4">
                    <p>
                        <i class="fas fa-calendar-check text-success-600 mr-2"></i>
                        Prontu√°rio criado em @Model.DataCriacao.ToString("dd/MM/yyyy '√†s' HH:mm")
                    </p>
                </div>
            </div>
        </div>

        <!-- Medical Record Content -->
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                <h2 class="text-xl font-semibold text-medical-800 mb-4">
                    <i class="fas fa-clipboard-list text-primary-600 mr-2"></i>
                    Anamnese e Exame F√≠sico
                </h2>
                
                @if (!string.IsNullOrEmpty(Model.HistoriaClinica))
                {
                    <div class="mb-6">
                        <h3 class="text-lg text-primary-800 mb-2">Hist√≥ria Cl√≠nica</h3>
                        <div class="bg-blue-50 p-4 rounded-lg text-medical-800">
                            <p>@Model.HistoriaClinica</p>
                        </div>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(Model.ExameFisico))
                {
                    <div>
                        <h3 class="text-lg text-primary-800 mb-2">Exame F√≠sico</h3>
                        <div class="bg-blue-50 p-4 rounded-lg text-medical-800">
                            <p>@Model.ExameFisico</p>
                        </div>
                    </div>
                }
                
                @if (string.IsNullOrEmpty(Model.HistoriaClinica) && string.IsNullOrEmpty(Model.ExameFisico))
                {
                    <p class="text-medical-500 italic">Nenhuma informa√ß√£o de anamnese ou exame f√≠sico registrada.</p>
                }
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                <h2 class="text-xl font-semibold text-medical-800 mb-4">
                    <i class="fas fa-stethoscope text-primary-600 mr-2"></i>
                    Diagn√≥stico e Plano
                </h2>
                
                @if (!string.IsNullOrEmpty(Model.Hipoteses))
                {
                    <div class="mb-6">
                        <h3 class="text-lg text-primary-800 mb-2">Hip√≥teses Diagn√≥sticas</h3>
                        <div class="bg-info-50 p-4 rounded-lg text-medical-800">
                            <p>@Model.Hipoteses</p>
                        </div>
                    </div>
                }
                
                <div class="mb-6">
                    <h3 class="text-lg text-primary-800 mb-2">Diagn√≥stico Principal</h3>
                    <div class="bg-success-50 p-4 rounded-lg text-medical-800 border-l-4 border-success-500">
                        <p class="font-medium">@Model.Diagnostico</p>
                    </div>
                </div>
                
                @if (!string.IsNullOrEmpty(Model.Tratamento))
                {
                    <div>
                        <h3 class="text-lg text-primary-800 mb-2">Plano de Tratamento</h3>
                        <div class="bg-info-50 p-4 rounded-lg text-medical-800">
                            <p>@Model.Tratamento</p>
                        </div>
                    </div>
                }
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                <h2 class="text-xl font-semibold text-medical-800 mb-4">
                    <i class="fas fa-prescription text-primary-600 mr-2"></i>
                    Prescri√ß√µes e Orienta√ß√µes
                </h2>
                
                @if (!string.IsNullOrEmpty(Model.Prescricoes))
                {
                    <div class="mb-6">
                        <h3 class="text-lg text-primary-800 mb-2">Medicamentos Prescritos</h3>
                        <div class="bg-warning-50 p-4 rounded-lg text-medical-800">
                            <p>@Model.Prescricoes</p>
                        </div>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(Model.ExamesSolicitados))
                {
                    <div class="mb-6">
                        <h3 class="text-lg text-primary-800 mb-2">Exames Solicitados</h3>
                        <div class="bg-indigo-50 p-4 rounded-lg text-medical-800">
                            <p>@Model.ExamesSolicitados</p>
                        </div>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(Model.OrientacoesGerais))
                {
                    <div class="mb-6">
                        <h3 class="text-lg text-primary-800 mb-2">Orienta√ß√µes Gerais</h3>
                        <div class="bg-blue-50 p-4 rounded-lg text-medical-800">
                            <p>@Model.OrientacoesGerais</p>
                        </div>
                    </div>
                }
                
                @if (Model.ProximaConsulta.HasValue)
                {
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <h3 class="text-lg text-green-800 mb-2">Retorno Agendado</h3>
                        <p class="text-green-700 font-medium">
                            <i class="fas fa-calendar-alt mr-2"></i>
                            @Model.ProximaConsulta.Value.ToString("dd/MM/yyyy")
                        </p>
                    </div>
                }
                
                @if (string.IsNullOrEmpty(Model.Prescricoes) && string.IsNullOrEmpty(Model.ExamesSolicitados) && 
                    string.IsNullOrEmpty(Model.OrientacoesGerais) && !Model.ProximaConsulta.HasValue)
                {
                    <p class="text-medical-500 italic">Nenhuma prescri√ß√£o ou orienta√ß√£o registrada.</p>
                }
            </div>
        </div>

        <!-- Download Button -->
        <div class="flex justify-end">
            <button onclick="downloadProntuarioPDF()" class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors duration-200 inline-flex items-center">
                <i class="fas fa-file-pdf mr-2"></i>
                Download Prontu√°rio
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        function downloadProntuarioPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configura√ß√£o do documento
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let yPosition = 20;
            
            // Cores do tema m√©dico
            const primaryBlue = [41, 128, 185];
            const darkBlue = [44, 62, 80];
            const lightGray = [236, 240, 241];
            const darkGray = [127, 140, 141];
            const accentGreen = [39, 174, 96];
            
            // Cabe√ßalho com logo e informa√ß√µes da cl√≠nica
            doc.setFillColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
            doc.rect(0, 0, pageWidth, 35, 'F');
            
            // Logo MedConsulta (simulado com texto estilizado)
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('MED', 15, 20);
            doc.setTextColor(lightGray[0], lightGray[1], lightGray[2]);
            doc.text('CONSULTA', 42, 20);
            
            // Subt√≠tulo do cabe√ßalho
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(255, 255, 255);
            doc.text('Sistema de Consultas M√©dicas Online', 15, 28);
            
            // Informa√ß√µes da cl√≠nica no canto direito
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('Tel: +244 923 456 789', pageWidth - 60, 18);
            doc.text('Email: contato@medconsulta.ao', pageWidth - 60, 24);
            doc.text('www.medconsulta.ao', pageWidth - 60, 30);
            
            yPosition = 50;
            
            // T√≠tulo do documento
            doc.setTextColor(darkBlue[0], darkBlue[1], darkBlue[2]);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text('PRONTU√ÅRIO M√âDICO', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;
            
            // Data de emiss√£o
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
            doc.text('Emitido em: ' + new Date().toLocaleDateString('pt-BR'), pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // Fun√ß√£o para criar se√ß√µes com fundo colorido
            function criarSecao(titulo, yPos) {
                doc.setFillColor(lightGray[0], lightGray[1], lightGray[2]);
                doc.rect(10, yPos - 8, pageWidth - 20, 12, 'F');
                doc.setTextColor(darkBlue[0], darkBlue[1], darkBlue[2]);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(titulo, 15, yPos);
                return yPos + 10;
            }
            
            // Fun√ß√£o para adicionar linha decorativa
            function adicionarLinha(yPos) {
                doc.setDrawColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
                doc.setLineWidth(0.5);
                doc.line(15, yPos, pageWidth - 15, yPos);
                return yPos + 5;
            }
            
            // Se√ß√£o de informa√ß√µes da consulta
            yPosition = criarSecao('üè• INFORMA√á√ïES DA CONSULTA', yPosition);
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            // Grid de informa√ß√µes da consulta
            const consultaY = yPosition;
            doc.text('Data e Hora:', 15, consultaY);
            doc.setFont(undefined, 'bold');
            doc.text('@Model.Consulta.DataHora.ToString("dd/MM/yyyy HH:mm")', 50, consultaY);
            
            doc.setFont(undefined, 'normal');
            doc.text('Tipo:', 120, consultaY);
            doc.setFont(undefined, 'bold');
            doc.text('@(Model.Consulta.Tipo == ConsultasMedicasOnline.Models.TipoConsulta.Presencial ? "Presencial" : "Online")', 140, consultaY);
            
            doc.setFont(undefined, 'normal');
            doc.text('Consulta N¬∫:', 15, consultaY + 8);
            doc.setFont(undefined, 'bold');
            doc.text('@Model.ConsultaId', 50, consultaY + 8);
            
            yPosition = consultaY + 20;
            yPosition = adicionarLinha(yPosition);
            
            // Se√ß√£o do paciente
            yPosition = criarSecao('üë§ DADOS DO PACIENTE', yPosition);
            
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            const pacienteY = yPosition;
            doc.text('Nome Completo:', 15, pacienteY);
            doc.setFont(undefined, 'bold');
            doc.text('@Model.Paciente.Usuario.Nome @Model.Paciente.Usuario.Sobrenome', 55, pacienteY);
            
            @if (Model.Paciente.DataNascimento.HasValue)
            {
                <text>
                doc.setFont(undefined, 'normal');
                doc.text('Data de Nascimento:', 15, pacienteY + 8);
                doc.setFont(undefined, 'bold');
                doc.text('@Model.Paciente.DataNascimento.Value.ToString("dd/MM/yyyy")', 70, pacienteY + 8);
                
                doc.setFont(undefined, 'normal');
                doc.text('Idade:', 130, pacienteY + 8);
                doc.setFont(undefined, 'bold');
                doc.text('@(DateTime.Now.Year - Model.Paciente.DataNascimento.Value.Year) anos', 150, pacienteY + 8);
                
                yPosition = pacienteY + 16;
                </text>
            }
            else
            {
                <text>yPosition = pacienteY + 8;</text>
            }
            
            @if (!string.IsNullOrEmpty(Model.Paciente.TipoSanguineo))
            {
                <text>
                doc.setFont(undefined, 'normal');
                doc.text('Tipo Sangu√≠neo:', 15, yPosition);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(accentGreen[0], accentGreen[1], accentGreen[2]);
                doc.text('@Model.Paciente.TipoSanguineo', 65, yPosition);
                doc.setTextColor(0, 0, 0);
                yPosition += 8;
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.Paciente.Alergias))
            {
                <text>
                doc.setFont(undefined, 'normal');
                doc.text('Alergias:', 15, yPosition);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(220, 53, 69);
                doc.text('@Model.Paciente.Alergias', 45, yPosition);
                doc.setTextColor(0, 0, 0);
                yPosition += 8;
                </text>
            }
            
            yPosition += 5;
            yPosition = adicionarLinha(yPosition);
            
            // Se√ß√£o do m√©dico
            yPosition = criarSecao('üë®‚Äç‚öïÔ∏è M√âDICO RESPONS√ÅVEL', yPosition);
            
            const medicoY = yPosition;
            doc.setFont(undefined, 'normal');
            doc.text('Nome:', 15, medicoY);
            doc.setFont(undefined, 'bold');
            doc.text('Dr. @Model.Medico.Usuario.Nome @Model.Medico.Usuario.Sobrenome', 40, medicoY);
            
            doc.setFont(undefined, 'normal');
            doc.text('Especialidade:', 15, medicoY + 8);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
            doc.text('@Model.Medico.Especialidade.Nome', 60, medicoY + 8);
            doc.setTextColor(0, 0, 0);
            
            doc.setFont(undefined, 'normal');
            doc.text('CRM:', 15, medicoY + 16);
            doc.setFont(undefined, 'bold');
            doc.text('@Model.Medico.CRM/@Model.Medico.EstadoCRM', 35, medicoY + 16);
            
            yPosition = medicoY + 25;
            yPosition = adicionarLinha(yPosition);
            
            // Verificar se precisa de nova p√°gina
            if (yPosition > pageHeight - 80) {
                doc.addPage();
                yPosition = 20;
            }
            
            // Se√ß√µes cl√≠nicas
            @if (!string.IsNullOrEmpty(Model.HistoriaClinica))
            {
                <text>
                yPosition = criarSecao('üìã HIST√ìRIA CL√çNICA', yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const historiaLines = doc.splitTextToSize('@Html.Raw(Model.HistoriaClinica.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
                doc.text(historiaLines, 15, yPosition);
                yPosition += historiaLines.length * 5 + 10;
                yPosition = adicionarLinha(yPosition);
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.ExameFisico))
            {
                <text>
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                yPosition = criarSecao('üîç EXAME F√çSICO', yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const exameLines = doc.splitTextToSize('@Html.Raw(Model.ExameFisico.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
                doc.text(exameLines, 15, yPosition);
                yPosition += exameLines.length * 5 + 10;
                yPosition = adicionarLinha(yPosition);
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.Hipoteses))
            {
                <text>
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                yPosition = criarSecao('ü§î HIP√ìTESES DIAGN√ìSTICAS', yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const hipotesesLines = doc.splitTextToSize('@Html.Raw(Model.Hipoteses.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
                doc.text(hipotesesLines, 15, yPosition);
                yPosition += hipotesesLines.length * 5 + 10;
                yPosition = adicionarLinha(yPosition);
                </text>
            }
            
            // Diagn√≥stico principal (destacado)
            if (yPosition > pageHeight - 60) {
                doc.addPage();
                yPosition = 20;
            }
            
            doc.setFillColor(accentGreen[0], accentGreen[1], accentGreen[2]);
            doc.rect(10, yPosition - 8, pageWidth - 20, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('‚úÖ DIAGN√ìSTICO PRINCIPAL', 15, yPosition);
            yPosition += 10;
            
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            const diagnosticoLines = doc.splitTextToSize('@Html.Raw(Model.Diagnostico.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
            doc.text(diagnosticoLines, 15, yPosition);
            yPosition += diagnosticoLines.length * 6 + 10;
            yPosition = adicionarLinha(yPosition);
            
            @if (!string.IsNullOrEmpty(Model.Tratamento))
            {
                <text>
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                yPosition = criarSecao('üíä PLANO DE TRATAMENTO', yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const tratamentoLines = doc.splitTextToSize('@Html.Raw(Model.Tratamento.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
                doc.text(tratamentoLines, 15, yPosition);
                yPosition += tratamentoLines.length * 5 + 10;
                yPosition = adicionarLinha(yPosition);
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.Prescricoes))
            {
                <text>
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                yPosition = criarSecao('üíâ PRESCRI√á√ïES M√âDICAS', yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const prescricoesLines = doc.splitTextToSize('@Html.Raw(Model.Prescricoes.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
                doc.text(prescricoesLines, 15, yPosition);
                yPosition += prescricoesLines.length * 5 + 10;
                yPosition = adicionarLinha(yPosition);
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.ExamesSolicitados))
            {
                <text>
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                yPosition = criarSecao('üß™ EXAMES SOLICITADOS', yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const examesLines = doc.splitTextToSize('@Html.Raw(Model.ExamesSolicitados.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
                doc.text(examesLines, 15, yPosition);
                yPosition += examesLines.length * 5 + 10;
                yPosition = adicionarLinha(yPosition);
                </text>
            }
            
            @if (!string.IsNullOrEmpty(Model.OrientacoesGerais))
            {
                <text>
                if (yPosition > pageHeight - 60) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                yPosition = criarSecao('üìù ORIENTA√á√ïES GERAIS', yPosition);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const orientacoesLines = doc.splitTextToSize('@Html.Raw(Model.OrientacoesGerais.Replace("\"", "\\\"").Replace("\n", " ").Replace("\r", " "))', pageWidth - 30);
                doc.text(orientacoesLines, 15, yPosition);
                yPosition += orientacoesLines.length * 5 + 10;
                yPosition = adicionarLinha(yPosition);
                </text>
            }
            
            @if (Model.ProximaConsulta.HasValue)
            {
                <text>
                if (yPosition > pageHeight - 40) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Pr√≥xima consulta destacada
                doc.setFillColor(255, 193, 7);
                doc.rect(10, yPosition - 8, pageWidth - 20, 20, 'F');
                doc.setTextColor(52, 58, 64);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('üìÖ RETORNO AGENDADO', 15, yPosition);
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('@Model.ProximaConsulta.Value.ToString("dd/MM/yyyy")', 15, yPosition + 10);
                yPosition += 25;
                </text>
            }
            
            // Rodap√© em todas as p√°ginas
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                
                // Linha do rodap√©
                doc.setDrawColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
                doc.setLineWidth(1);
                doc.line(15, pageHeight - 25, pageWidth - 15, pageHeight - 25);
                
                // Informa√ß√µes do rodap√©
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text('Prontu√°rio gerado em: ' + new Date().toLocaleString('pt-BR'), 15, pageHeight - 18);
                doc.text('Data de cria√ß√£o: @Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")', 15, pageHeight - 12);
                
                // Assinatura digital
                doc.setTextColor(primaryBlue[0], primaryBlue[1], primaryBlue[2]);
                doc.setFont(undefined, 'bold');
                doc.text('MedConsulta - Sistema M√©dico Digital', pageWidth - 80, pageHeight - 18);
                doc.setFont(undefined, 'normal');
                doc.text(`P√°gina ${i} de ${totalPages}`, pageWidth - 30, pageHeight - 12);
                
                // C√≥digo de verifica√ß√£o
                doc.setFontSize(6);
                doc.setTextColor(darkGray[0], darkGray[1], darkGray[2]);
                doc.text('C√≥digo de verifica√ß√£o: MED-@Model.Id-@Model.DataCriacao.ToString("yyyyMMdd")', 15, pageHeight - 6);
            }
            
            // Salvar o PDF com nome personalizado
            const fileName = `Prontuario_@(Model.Paciente.Usuario.Nome.Replace(" ", "_"))_@(Model.Consulta.DataHora.ToString("yyyyMMdd")).pdf`;
            doc.save(fileName);
        }
    </script>
}
