@model ConsultasMedicasOnline.Models.Consulta

@{
    ViewData["Title"] = "Detalhes da Consulta";
}

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-white py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    
        @if (TempData["Success"] != null)
        {
            <div class="mb-6 bg-green-100 border-l-4 border-green-500 p-4 rounded-md flex items-start">
                <div class="flex-shrink-0 mt-0.5">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-green-800 font-medium">Agendamento realizado!</h3>
                    <div class="mt-1 text-green-700 text-sm">
                        @TempData["Success"]
                    </div>
                </div>
            </div>
        }

        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-sm border border-medical-200 p-8 mb-8">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-medical-800">
                        <i class="fas fa-clipboard-list text-primary-600 mr-3"></i>
                        Detalhes da Consulta
                    </h1>
                    <p class="text-medical-600 mt-2">
                        Consulta #@Model.Id - 
                        <span class="@GetStatusClass()">@GetStatusText()</span>
                    </p>
                </div>
                <div class="flex space-x-3">
                    <a href="javascript:history.back()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </a>
                    
                </div>
            </div>
            
            @if (Model.Status == ConsultasMedicasOnline.Models.StatusConsulta.Agendada)
            {
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <p class="font-medium">Aguardando aprovação</p>
                            <p class="text-sm">Esta consulta está aguardando confirmação pelo médico. Você receberá uma notificação quando for aprovada.</p>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Detalhes da Consulta -->
            <div class="md:col-span-2 space-y-6">
                <!-- Informações Gerais -->
                <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                    <h2 class="text-xl font-semibold text-medical-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle text-primary-600 mr-2"></i>
                        Informações Gerais
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <h4 class="text-xs uppercase text-gray-500 font-semibold">Data</h4>
                            <p class="text-medical-800">@Model.DataHora.ToString("dd/MM/yyyy")</p>
                        </div>
                        <div>
                            <h4 class="text-xs uppercase text-gray-500 font-semibold">Horário</h4>
                            <p class="text-medical-800">@Model.DataHora.ToString("HH:mm")</p>
                        </div>
                        <div>
                            <h4 class="text-xs uppercase text-gray-500 font-semibold">Tipo</h4>
                            <p class="text-medical-800">
                                @if (Model.Tipo == ConsultasMedicasOnline.Models.TipoConsulta.Presencial)
                                {
                                    <span><i class="fas fa-clinic-medical text-medical-600 mr-1"></i> Presencial</span>
                                }
                                else
                                {
                                    <span><i class="fas fa-video text-medical-600 mr-1"></i> Online</span>
                                }
                            </p>
                        </div>
                        <div>
                            <h4 class="text-xs uppercase text-gray-500 font-semibold">Duração</h4>
                            <p class="text-medical-800">@Model.DuracaoMinutos minutos</p>
                        </div>
                    </div>

                    <hr class="my-4 border-medical-100" />
                    
                    <div>
                        <h4 class="text-xs uppercase text-gray-500 font-semibold mb-2">Motivo da Consulta</h4>
                        <p class="text-medical-800 bg-gray-50 p-3 rounded">
                            @(string.IsNullOrEmpty(Model.MotivoConsulta) ? "Não informado" : Model.MotivoConsulta)
                        </p>
                    </div>
                </div>
                
                <!-- Observações -->
                @if (!string.IsNullOrEmpty(Model.ObservacoesGerais))
                {
                    <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                        <h2 class="text-xl font-semibold text-medical-800 mb-4 flex items-center">
                            <i class="fas fa-sticky-note text-primary-600 mr-2"></i>
                            Observações Gerais
                        </h2>
                        
                        <p class="text-medical-700 bg-gray-50 p-3 rounded">@Model.ObservacoesGerais</p>
                    </div>
                }
            </div>
            
            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Médico -->
                <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                    <h2 class="text-lg font-semibold text-medical-800 mb-4 flex items-center">
                        <i class="fas fa-user-md text-primary-600 mr-2"></i>
                        Médico
                    </h2>
                    
                    <div class="flex items-center mb-4">
                        <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="font-semibold text-medical-800">Dr. @Model.Medico.Usuario.Nome @Model.Medico.Usuario.Sobrenome</h3>
                            <p class="text-sm text-medical-600">@Model.Medico.Especialidade.Nome</p>
                        </div>
                    </div>
                    
                    <div class="text-sm text-medical-700">
                        <p class="flex items-center mb-2">
                            <span class="w-5 text-center mr-2"><i class="fas fa-id-card text-medical-500"></i></span>
                            <span>Cód. Carteira: @Model.Medico.CRM</span>
                        </p>
                    </div>
                </div>
                
                <!-- Paciente -->
                <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                    <h2 class="text-lg font-semibold text-medical-800 mb-4 flex items-center">
                        <i class="fas fa-user text-primary-600 mr-2"></i>
                        Paciente
                    </h2>
                    
                    <div class="flex items-center mb-4">
                        <div class="h-12 w-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="font-semibold text-medical-800">@Model.Paciente.Usuario.Nome @Model.Paciente.Usuario.Sobrenome</h3>
                            <p class="text-sm text-medical-600">@Model.Paciente.Usuario.Email</p>
                        </div>
                    </div>
                </div>
                
                <!-- Ações -->
                <div class="bg-white rounded-xl shadow-sm border border-medical-200 p-6">
                    <h2 class="text-lg font-semibold text-medical-800 mb-4 flex items-center">
                        <i class="fas fa-cog text-primary-600 mr-2"></i>
                        Ações
                    </h2>
                    
                    <div class="space-y-3">
                        @if(Model.Status == ConsultasMedicasOnline.Models.StatusConsulta.Agendada && (User.IsInRole("Medico") || User.IsInRole("Administrador")))
                        {
                            <form asp-action="ChangeStatus" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@Model.Id" />
                                <input type="hidden" name="newStatus" value="@ConsultasMedicasOnline.Models.StatusConsulta.Confirmada" />
                                <button type="submit" class="w-full py-2 px-4 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors text-sm font-medium flex justify-center items-center">
                                    <i class="fas fa-check mr-2"></i>
                                    Confirmar Consulta
                                </button>
                            </form>
                            
                            <form asp-action="Cancel" asp-route-id="@Model.Id" method="post" onsubmit="return confirm('Tem certeza que deseja cancelar esta consulta?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="w-full py-2 px-4 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-colors text-sm font-medium flex justify-center items-center">
                                    <i class="fas fa-calendar-times mr-2"></i>
                                    Cancelar Consulta
                                </button>
                            </form>
                        }
                        else if(Model.Status == ConsultasMedicasOnline.Models.StatusConsulta.Confirmada)
                        {
                            @if(Model.DataHora > DateTime.Now)
                            {
                                <a href="#" class="w-full py-2 px-4 bg-green-100 hover:bg-green-200 text-green-700 rounded-lg transition-colors text-sm font-medium flex justify-center items-center">
                                    <i class="fas fa-video mr-2"></i>
                                    Entrar na Consulta
                                </a>
                                
                                <form asp-action="Cancel" asp-route-id="@Model.Id" method="post" onsubmit="return confirm('Tem certeza que deseja cancelar esta consulta confirmada?');">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="w-full py-2 px-4 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-colors text-sm font-medium flex justify-center items-center">
                                        <i class="fas fa-calendar-times mr-2"></i>
                                        Cancelar Consulta
                                    </button>
                                </form>
                            }
                            else
                            {
                                <form asp-action="ChangeStatus" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@Model.Id" />
                                    <input type="hidden" name="newStatus" value="@ConsultasMedicasOnline.Models.StatusConsulta.Concluida" />
                                    <button type="submit" class="w-full py-2 px-4 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-colors text-sm font-medium flex justify-center items-center">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        Marcar Como Concluída
                                    </button>
                                </form>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    private string GetStatusClass()
    {
        return Model.Status switch
        {
            ConsultasMedicasOnline.Models.StatusConsulta.Agendada => "text-yellow-600",
            ConsultasMedicasOnline.Models.StatusConsulta.Confirmada => "text-green-600",
            ConsultasMedicasOnline.Models.StatusConsulta.Concluida => "text-blue-600",
            ConsultasMedicasOnline.Models.StatusConsulta.Cancelada => "text-red-600",
            _ => "text-gray-600"
        };
    }

    private string GetStatusText()
    {
        return Model.Status switch
        {
            ConsultasMedicasOnline.Models.StatusConsulta.Agendada => "Aguardando Aprovação",
            ConsultasMedicasOnline.Models.StatusConsulta.Confirmada => "Confirmada",
            ConsultasMedicasOnline.Models.StatusConsulta.Concluida => "Concluída",
            ConsultasMedicasOnline.Models.StatusConsulta.Cancelada => "Cancelada",
            _ => Model.Status.ToString()
        };
    }
}
                        }
                    </div>
                </div>

                <!-- Medical Record -->
                @if (Model.Prontuario != null || (User.IsInRole("Medico") && Model.Status == StatusConsulta.Concluida))
                {
                    <div class="bg-white rounded-xl shadow-sm border border-medical-200 overflow-hidden">
                        <div class="px-6 py-4 bg-gradient-to-r from-medical-600 to-medical-700 border-b border-medical-200">
                            <h2 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas fa-file-medical mr-3"></i>
                                Prontuário Médico
                            </h2>
                        </div>

                        <div class="p-6">
                            @if (Model.Prontuario != null)
                            {
                                <div class="space-y-4">
                                    @if (!string.IsNullOrEmpty(Model.Prontuario.Diagnostico))
                                    {
                                        <div>
                                            <label class="block text-sm font-medium text-medical-700 mb-2">Diagnóstico</label>
                                            <div class="p-4 bg-success-50 border border-success-200 rounded-lg">
                                                <p class="text-success-800 font-semibold">@Model.Prontuario.Diagnostico</p>
                                            </div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(Model.Prontuario.Tratamento))
                                    {
                                        <div>
                                            <label class="block text-sm font-medium text-medical-700 mb-2">Tratamento</label>
                                            <div class="p-4 bg-medical-50 rounded-lg">
                                                <p class="text-medical-900">@Model.Prontuario.Tratamento</p>
                                            </div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(Model.Prontuario.Prescricoes))
                                    {
                                        <div>
                                            <label class="block text-sm font-medium text-medical-700 mb-2">Prescrições</label>
                                            <div class="p-4 bg-warning-50 border border-warning-200 rounded-lg">
                                                <p class="text-warning-800">@Model.Prontuario.Prescricoes</p>
                                            </div>
                                        </div>
                                    }

                                    <div class="flex justify-end">
                                        <a href="#" class="bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors duration-200 inline-flex items-center">
                                            <i class="fas fa-file-pdf mr-2"></i>
                                            Download Prontuário
                                        </a>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-8">
                                    <i class="fas fa-file-medical text-4xl text-medical-300 mb-4"></i>
                                    <p class="text-medical-600">Prontuário ainda não foi preenchido</p>
                                    @if (User.IsInRole("Medico"))
                                    {
                                        <button class="mt-4 bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors duration-200 inline-flex items-center">
                                            <i class="fas fa-plus mr-2"></i>
                                            Criar Prontuário
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Doctor Information -->
                @if (!User.IsInRole("Medico"))
                {
                    <div class="bg-white rounded-xl shadow-sm border border-medical-200 overflow-hidden">
                        <div class="px-6 py-4 bg-gradient-to-r from-primary-500 to-primary-600 border-b border-medical-200">
                            <h3 class="text-lg font-semibold text-white flex items-center">
                                <i class="fas fa-user-md mr-2"></i>
                                Médico
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="h-16 w-16 rounded-full bg-primary-100 flex items-center justify-center">
                                    <span class="text-primary-600 font-bold text-xl">
                                        @Model.Medico.Usuario?.Nome?.First()@Model.Medico.Usuario?.Sobrenome?.First()
                                    </span>
                                </div>
                                <div class="ml-4">
                                    <h4 class="font-semibold text-medical-800">
                                        Dr. @Model.Medico.Usuario?.Nome @Model.Medico.Usuario?.Sobrenome
                                    </h4>
                                    <p class="text-sm text-medical-600">@Model.Medico.Especialidade?.Nome</p>
                                    <p class="text-xs text-medical-500">CRM @Model.Medico.CRM/@Model.Medico.EstadoCRM</p>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <a asp-controller="Medicos" asp-action="Details" asp-route-id="@Model.Medico.Id" 
                                   class="w-full bg-primary-600 text-white px-4 py-2 rounded-lg hover:bg-primary-700 transition-colors duration-200 text-center inline-block">
                                    <i class="fas fa-eye mr-2"></i>
                                    Ver Perfil Completo
                                </a>
                                
                                @if (User.IsInRole("Paciente") && Model.Status != StatusConsulta.Concluida)
                                {
                                    <button class="w-full bg-success-600 text-white px-4 py-2 rounded-lg hover:bg-success-700 transition-colors duration-200">
                                        <i class="fas fa-phone mr-2"></i>
                                        Contatar Médico
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Patient Information -->
                @if (!User.IsInRole("Paciente"))
                {
                    <div class="bg-white rounded-xl shadow-sm border border-medical-200 overflow-hidden">
                        <div class="px-6 py-4 bg-gradient-to-r from-medical-500 to-medical-600 border-b border-medical-200">
                            <h3 class="text-lg font-semibold text-white flex items-center">
                                <i class="fas fa-user mr-2"></i>
                                Paciente
                            </h3>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="h-16 w-16 rounded-full bg-medical-100 flex items-center justify-center">
                                    <span class="text-medical-600 font-bold text-xl">
                                        @Model.Paciente.Usuario?.Nome?.First()@Model.Paciente.Usuario?.Sobrenome?.First()
                                    </span>
                                </div>
                                <div class="ml-4">
                                    <h4 class="font-semibold text-medical-800">
                                        @Model.Paciente.Usuario?.Nome @Model.Paciente.Usuario?.Sobrenome
                                    </h4>
                                    <p class="text-sm text-medical-600">@Model.Paciente.Usuario?.Email</p>
                                    @if (!string.IsNullOrEmpty(Model.Paciente.Usuario?.Telefone))
                                    {
                                        <p class="text-xs text-medical-500">@Model.Paciente.Usuario.Telefone</p>
                                    }
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <a asp-controller="Pacientes" asp-action="Details" asp-route-id="@Model.Paciente.Id" 
                                   class="w-full bg-medical-600 text-white px-4 py-2 rounded-lg hover:bg-medical-700 transition-colors duration-200 text-center inline-block">
                                    <i class="fas fa-eye mr-2"></i>
                                    Ver Perfil Completo
                                </a>
                            </div>
                        </div>
                    </div>
                }

                <!-- Consultation Timeline -->
                <div class="bg-white rounded-xl shadow-sm border border-medical-200 overflow-hidden">
                    <div class="px-6 py-4 bg-gradient-to-r from-info-500 to-info-600 border-b border-medical-200">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            <i class="fas fa-history mr-2"></i>
                            Linha do Tempo
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-info-100 flex items-center justify-center">
                                    <i class="fas fa-plus text-info-600 text-sm"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium text-medical-800">Consulta agendada</p>
                                    <p class="text-xs text-medical-500">@Model.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                                </div>
                            </div>
                            
                            @if (Model.Status != StatusConsulta.Agendada)
                            {
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-success-100 flex items-center justify-center">
                                        <i class="fas fa-check text-success-600 text-sm"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-medical-800">Status atualizado</p>
                                        <p class="text-xs text-medical-500">@(Model.Status.ToString())</p>
                                    </div>
                                </div>
                            }
                            
                            @if (Model.Status == StatusConsulta.Cancelada && Model.DataCancelamento.HasValue)
                            {
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-danger-100 flex items-center justify-center">
                                        <i class="fas fa-times text-danger-600 text-sm"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-medical-800">Consulta cancelada</p>
                                        <p class="text-xs text-medical-500">@Model.DataCancelamento.Value.ToString("dd/MM/yyyy HH:mm")</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function cancelarConsulta(consultaId) {
            const motivo = prompt('Informe o motivo do cancelamento:');
            if (motivo && motivo.trim()) {
                if (confirm('Tem certeza de que deseja cancelar esta consulta?')) {
                    $.post('@Url.Action("Cancelar")', {
                        id: consultaId,
                        motivo: motivo.trim()
                    }, function() {
                        location.reload();
                    }).fail(function() {
                        alert('Erro ao cancelar a consulta. Tente novamente.');
                    });
                }
            }
        }
        
        function iniciarConsulta(consultaId) {
            if (confirm('Deseja iniciar esta consulta agora?')) {
                $.post('@Url.Action("IniciarConsulta")', {
                    id: consultaId
                }, function() {
                    location.reload();
                }).fail(function() {
                    alert('Erro ao iniciar a consulta. Tente novamente.');
                });
            }
        }
    </script>
}
